<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sheep Jump Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        #game-container {
            position: relative;
            width: 600px;
            height: 400px;
            border: 2px solid #333;
            background-color: #87CEEB;
        }
        #score {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 20px;
            z-index: 20;
            color: white;
            text-shadow: 1px 1px 2px black;
        }
        #start-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            text-align: center;
            z-index: 20;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="score">Score: 0</div>
        <div id="start-message">Press SPACE to Start</div>
        <canvas id="gameCanvas"></canvas>
    </div>

    <script>
        // Game configuration
        const config = {
            width: 600,
            height: 400,
            groundHeight: 50,
            sheepStartX: 100,
            sheepStartY: 300,
            jumpStrength: 0.15,
            obstacleSpeed: 5
        };

        // Matter.js setup
        const { Engine, Render, Runner, Bodies, Composite, Events, Vector } = Matter;
        
        class SheepGame {
            constructor() {
                this.engine = Engine.create();
                this.world = this.engine.world;
                
                // Delta time tracking
                this.lastTime = 0;
                this.deltaTime = 0;

                // Canvas setup
                this.canvas = document.getElementById('gameCanvas');
                this.canvas.width = config.width;
                this.canvas.height = config.height;
                
                this.render = Render.create({
                    canvas: this.canvas,
                    engine: this.engine,
                    options: {
                        width: config.width,
                        height: config.height,
                        wireframes: false,
                        background: '#87CEEB'
                    }
                });

                // Game state
                this.score = 0;
                this.isGameStarted = false;
                this.isGameOver = false;
                this.scoreElement = document.getElementById('score');
                this.startMessage = document.getElementById('start-message');

                // Sprite images
                this.sheepImages = [
                    'image/sheep-1.png',
                    'image/sheep-2.png', 
                    'image/sheep-3.png', 
                    'image/sheep-4.png'
                ];
                this.currentSheepImage = 0;
                this.animationTimer = 0;

                this.setupWorld();
                this.attachEventListeners();
            }

            setupWorld() {
                // Ground
                this.ground = Bodies.rectangle(
                    config.width / 2, 
                    config.height - config.groundHeight / 2, 
                    config.width, 
                    config.groundHeight, 
                    { isStatic: true, render: { fillStyle: '#8BC34A' } }
                );

                // Sheep (reduced size and collider)
                this.sheep = Bodies.rectangle(
                    config.sheepStartX, 
                    config.sheepStartY, 
                    70, 70, 
                    { 
                        label: 'sheep',
                        mass: 1,
                        render: { 
                            sprite: { 
                                texture: this.sheepImages[0]
                            }
                        }
                    }
                );

                Composite.add(this.world, [this.ground, this.sheep]);
            }

            attachEventListeners() {
                document.addEventListener('keydown', (event) => {
                    if (event.code === 'Space') {
                        event.preventDefault();
                        this.handleSpacePress();
                    }
                });

                // Collision detection
                Events.on(this.engine, 'collisionStart', (event) => {
                    const pairs = event.pairs;
                    for (let pair of pairs) {
                        if (
                            (pair.bodyA.label === 'sheep' && pair.bodyB.label === 'obstacle') ||
                            (pair.bodyB.label === 'sheep' && pair.bodyA.label === 'obstacle')
                        ) {
                            this.gameOver();
                        }
                    }
                });
            }

            handleSpacePress() {
                if (this.isGameOver) {
                    this.restart();
                    return;
                }

                if (!this.isGameStarted) {
                    this.start();
                }

                // More controlled jump
                if (this.sheep.position.y > config.height - config.groundHeight - 100) {
                    Matter.Body.applyForce(this.sheep, this.sheep.position, {
                        x: 0,
                        y: -config.jumpStrength
                    });
                }
            }

            start() {
                if (this.isGameStarted) return;

                this.isGameStarted = true;
                this.isGameOver = false;
                this.score = 0;
                this.scoreElement.textContent = `Score: ${this.score}`;
                this.startMessage.style.display = 'none';

                // Start rendering with frame timing
                Render.run(this.render);
                this.runner = Runner.create();
                this.gameLoop();
            }

            gameLoop(currentTime = 0) {
                if (!this.isGameStarted || this.isGameOver) return;

                // Calculate delta time
                if (this.lastTime === 0) this.lastTime = currentTime;
                this.deltaTime = currentTime - this.lastTime;
                this.lastTime = currentTime;

                // Update physics engine with delta time
                Engine.update(this.engine, this.deltaTime);

                // Animate sheep
                this.animationTimer += this.deltaTime;
                if (this.animationTimer >= 100) {
                    this.currentSheepImage = (this.currentSheepImage + 1) % this.sheepImages.length;
                    this.sheep.render.sprite.texture = this.sheepImages[this.currentSheepImage];
                    this.animationTimer = 0;
                }

                // Increment score
                this.score += 1;
                this.scoreElement.textContent = `Score: ${this.score}`;

                // Continue game loop
                requestAnimationFrame((time) => this.gameLoop(time));
            }

            generateObstacle() {
                if (!this.isGameStarted || this.isGameOver) return;

                // Randomly choose left or right side
                const isFromRight = Math.random() > 0.5;
                const x = isFromRight ? config.width + 50 : -50;
                const obstacle = Bodies.rectangle(x, config.height - config.groundHeight - 40, 80, 80, {
                    label: 'obstacle',
                    render: { 
                        sprite: { 
                            texture: 'image/fence.png'
                        }
                    },
                    isStatic: false,
                    friction: 0,
                    frictionAir: 0,
                    restitution: 0
                });

                // Set initial velocity
                Matter.Body.setVelocity(obstacle, { 
                    x: isFromRight ? -config.obstacleSpeed : config.obstacleSpeed, 
                    y: 0 
                });

                Composite.add(this.world, obstacle);

                // Remove obstacle when out of bounds
                const removeObstacle = () => {
                    if (
                        obstacle.position.x < -100 || 
                        obstacle.position.x > config.width + 100
                    ) {
                        Composite.remove(this.world, obstacle);
                    }
                };

                Events.on(this.engine, 'afterUpdate', removeObstacle);
            }

            gameOver() {
                if (this.isGameOver) return;

                this.isGameOver = true;
                this.isGameStarted = false;

                this.startMessage.textContent = `Game Over! Score: ${this.score}\nPress SPACE to Restart`;
                this.startMessage.style.display = 'block';

                // Stop physics
                Render.stop(this.render);
            }

            restart() {
                // Clear world
                Composite.clear(this.world, false);
                
                // Reset game state
                this.lastTime = 0;
                this.setupWorld();
                this.start();
            }
        }

        // Initialize game when window loads
        window.addEventListener('load', () => {
            new SheepGame();
        });
    </script>
</body>
</html>